---
phase: 07-markdown-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/blog/hello-world.md
  - src/plugins/blogManifest.js
  - vite.config.js
autonomous: true

must_haves:
  truths:
    - "Markdown files in src/content/blog/ are discovered at build time"
    - "Frontmatter metadata (title, date, description, tags) is parsed correctly"
    - "Build fails with clear error when required frontmatter fields are missing"
    - "Blog manifest JSON is generated with all post metadata sorted newest-first"
    - "Production build succeeds and includes manifest"
  artifacts:
    - path: "src/content/blog/hello-world.md"
      provides: "Sample blog post with all frontmatter fields"
      contains: "title:"
    - path: "src/plugins/blogManifest.js"
      provides: "Vite plugin for markdown discovery, parsing, manifest generation"
      min_lines: 60
    - path: "vite.config.js"
      provides: "Updated config with blog manifest plugin"
      contains: "blogManifest"
  key_links:
    - from: "src/plugins/blogManifest.js"
      to: "src/content/blog/*.md"
      via: "glob discovery at build time"
      pattern: "glob.*content/blog"
    - from: "vite.config.js"
      to: "src/plugins/blogManifest.js"
      via: "plugin import"
      pattern: "import.*blogManifest"
---

<objective>
Build the markdown processing infrastructure: a Vite plugin that discovers markdown files, parses frontmatter, validates required fields, calculates reading time, and generates a blog manifest JSON.

Purpose: Creates the data layer that Phase 8 (Blog Index) and Phase 9 (Markdown Rendering) will consume.
Output: Working Vite plugin, sample blog post, manifest generated on build.
</objective>

<execution_context>
@/home/sanderburuma/.claude/get-shit-done/workflows/execute-plan.md
@/home/sanderburuma/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-markdown-infrastructure/07-CONTEXT.md
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sample blog post and Vite blog manifest plugin</name>
  <files>src/content/blog/hello-world.md, src/plugins/blogManifest.js</files>
  <action>
1. Create `src/content/blog/hello-world.md` — a sample post demonstrating all frontmatter fields and common markdown patterns (headings, code blocks, lists, links, images, bold/italic). Frontmatter must include:
   - title, date (YYYY-MM-DD), description, tags (array), author (optional, defaults handled by plugin)
   - Use a realistic date and content about the blog launch

2. Create `src/plugins/blogManifest.js` — a Vite plugin that:
   - Discovers all `.md` files in `src/content/blog/` using `fs` and `path` (Node built-ins, no glob library needed for a single directory)
   - Parses frontmatter using a simple parser (split on `---` delimiters, parse YAML-like key:value pairs). Do NOT add a gray-matter dependency — write a lightweight parser that handles strings, arrays (YAML `- item` syntax), and dates. This keeps the build dependency-free.
   - Validates required fields: title, date, description, tags. On missing field, throw an error with the filename and missing field name so the build fails clearly.
   - Calculates reading time from word count (~200 wpm), rounded up to nearest minute.
   - Extracts slug from filename (strip `.md`).
   - Defaults author to "Sander Buruma" if not in frontmatter.
   - Detects featured image: use frontmatter `image` field if present, otherwise scan content for first `![...](...)`  match.
   - Generates manifest as a virtual module `virtual:blog-manifest` that exports an array of post metadata objects sorted newest-first by date. Each object: `{ slug, title, date, description, tags, author, readingTime, image }`.
   - Also includes full markdown content body (post-frontmatter) in each manifest entry as `content` field — Phase 9 needs this for rendering.
   - Plugin hooks: use `resolveId` and `load` for the virtual module pattern. Use `handleHotUpdate` to regenerate when .md files change in dev mode.
  </action>
  <verify>
    Run `npm run build` — build succeeds without errors.
    Check that `src/content/blog/hello-world.md` exists with valid frontmatter.
  </verify>
  <done>Vite plugin discovers markdown, parses frontmatter, validates fields, generates virtual module manifest. Sample post exists.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate plugin into Vite config and verify build</name>
  <files>vite.config.js</files>
  <action>
1. Import `blogManifest` from `./src/plugins/blogManifest.js` in vite.config.js.
2. Add `blogManifest()` to the plugins array (before the inline-css plugin).
3. Run `npm run build` and verify:
   - Build completes successfully
   - No warnings about missing modules
4. Create a temporary test: add a second markdown file `src/content/blog/test-validation.md` with a MISSING required field (e.g., no `title`). Run `npm run build` — confirm it fails with a clear error message mentioning the filename and missing field. Then DELETE this test file.
5. Run `npm run build` one final time to confirm clean build with just the sample post.
  </action>
  <verify>
    `npm run build` succeeds. Removing a required frontmatter field causes a build failure with a descriptive error.
  </verify>
  <done>Plugin integrated into Vite config. Build succeeds with valid posts. Build fails clearly on invalid frontmatter.</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- `src/content/blog/hello-world.md` has all required frontmatter fields
- Blog manifest plugin is loaded in vite.config.js
- Missing frontmatter causes descriptive build failure
</verification>

<success_criteria>
- Markdown files in src/content/blog/ are discovered and parsed at build time
- Frontmatter validation rejects posts missing required fields with clear errors
- Blog manifest virtual module exports sorted post metadata array
- Production build succeeds with sample content
</success_criteria>

<output>
After completion, create `.planning/phases/07-markdown-infrastructure/07-01-SUMMARY.md`
</output>
